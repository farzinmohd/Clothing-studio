{% extends 'base.html' %}
{% load static %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'dashboard/css/dashboard.css' %}">

<h2 class="mb-4">üìä Admin Dashboard</h2>

<!-- ================= STATS ================= -->
<div class="row">
    <div class="col-md-4">
        <div class="card stat-card">
            <h5>Total Users</h5>
            <h2>{{ total_users }}</h2>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card stat-card">
            <h5>Total Orders</h5>
            <h2>{{ total_orders }}</h2>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card stat-card">
            <h5>Total Revenue</h5>
            <h2>‚Çπ{{ total_revenue }}</h2>
        </div>
    </div>
</div>

<hr>

<!-- ================= CHARTS ================= -->
<div class="row mt-4">

    <!-- DONUT: Orders by Status -->
    <div class="col-md-6">
        <h5>Orders by Status</h5>
        <div style="max-width:350px; height:350px;">
            <canvas id="statusChart"></canvas>
        </div>
    </div>

    <!-- LINE: Monthly Sales -->
    <div class="col-md-6">
        <h5>Monthly Sales</h5>
        <div style="height:350px;">
            <canvas id="salesChart"></canvas>
        </div>
    </div>

</div>

<hr>

<!-- ================= TOP PRODUCTS ================= -->
<h5 class="mt-4">üèÜ Top Selling Products</h5>

<table class="table table-striped">
    <thead>
        <tr>
            <th>Product</th>
            <th>Units Sold</th>
        </tr>
    </thead>
    <tbody>
        {% for p in top_products %}
        <tr>
            <td>{{ p.product__name }}</td>
            <td>{{ p.total_qty }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- ================= DATA VALIDATION (JSON Scripts) ================= -->
{{ months|json_script:"months-data" }}
{{ totals|json_script:"totals-data" }}
{{ status_data|json_script:"status-data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Helper to safely parse JSON from script tags
    const getJsonData = (id) => JSON.parse(document.getElementById(id).textContent);

    const monthsData = getJsonData('months-data');
    const totalsData = getJsonData('totals-data');
    const statusData = getJsonData('status-data');

    /* ================= DONUT CHART ================= */
    const statusCtx = document.getElementById('statusChart').getContext('2d');

    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: statusData.map(item => item.status),
            datasets: [{
                data: statusData.map(item => item.count),
                backgroundColor: [
                    '#0d6efd',
                    '#198754',
                    '#ffc107',
                    '#dc3545',
                    '#6f42c1'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '65%',
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    /* ================= MONTHLY SALES ================= */
    const salesCtx = document.getElementById('salesChart').getContext('2d');

    new Chart(salesCtx, {
        type: 'line',
        data: {
            labels: monthsData,
            datasets: [{
                label: 'Monthly Sales',
                data: totalsData,
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13,110,253,0.2)',
                borderWidth: 3,
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
</script>

<hr class="my-4">

<!-- ================= REPORT DOWNLOADS ================= -->
<div class="d-flex justify-content-center gap-3 mb-4">
    <a href="{% url 'sales_report_pdf' %}" class="btn btn-danger">
        üìÑ Download PDF Report
    </a>

    <a href="{% url 'sales_report_excel' %}" class="btn btn-success">
        üìä Download Excel Report
    </a>

    <a href="{% url 'trigger_pricing_update' %}" class="btn btn-primary">
        üöÄ Update AI Prices Now
    </a>
</div>

{% endblock %}
